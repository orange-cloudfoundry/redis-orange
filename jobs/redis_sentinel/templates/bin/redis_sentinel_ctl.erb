#!/bin/bash
<% sentinel=link('redis_sentinel_conn') %>

REDIS_HOME="/var/vcap/packages/redis";
REDIS_SERVER="${REDIS_HOME}/bin/redis-server";
REDIS_CLI="${REDIS_HOME}/bin/redis-cli";
REDIS_SENTINEL_RUN_DIR="<%= p('run_dir') %>";
REDIS_SENTINEL_LOG_DIR="<%= p('log_dir') %>";
REDIS_SENTINEL_LOG_FILE="${REDIS_SENTINEL_LOG_DIR}/<%= p('logfile') %>";
REDIS_SENTINEL_STORE_DIR="<%= p('dir') %>";
REDIS_SENTINEL_PID_FILE="${REDIS_SENTINEL_RUN_DIR}/<%= p('pidfile') %>";
REDIS_SENTINEL_CONF="/var/vcap/jobs/redis_sentinel/config/redis_sentinel.conf";

REDIS_SENTINEL_IP="127.0.0.1";
<% if sentinel.p('bind') %>
REDIS_SENTINEL_IP="<%= spec.ip %>";
<% end %>
REDIS_SENTINEL_PORT="<%= sentinel.p('port') %>";

REDIS_SENTINEL_CRED="";
<% sentinel.if_p('password') do |x|
    unless x.to_s.empty? %>
REDIS_SENTINEL_CRED="-a <%= x %>";
<%  end
  end %>

<% if sentinel.p('tls') %>
REDIS_SENTINEL_PORT="<%= sentinel.p('tls_port') %>";
REDIS_SENTINEL_TLS_KEYS_DIR="<%= p('tls_keys_dir') %>";
REDIS_SENTINEL_TLS_CERT_FILE="${REDIS_SENTINEL_TLS_KEYS_DIR}/<%= p('tls_cert_file') %>";
REDIS_SENTINEL_CRED+=" --tls --cert \"${REDIS_SENTINEL_TLS_CERT_FILE}\"";
REDIS_SENTINEL_TLS_KEY_FILE="${REDIS_SENTINEL_TLS_KEYS_DIR}/<%= p('tls_key_file') %>";
REDIS_SENTINEL_CRED+=" --key \"${REDIS_SENTINEL_TLS_KEY_FILE}\"";
REDIS_SENTINEL_TLS_CA_CERT_FILE="${REDIS_SENTINEL_TLS_KEYS_DIR}/<%= p('tls_ca_cert_file') %>";
REDIS_SENTINEL_CRED+=" --cacert \"${REDIS_SENTINEL_TLS_CA_CERT_FILE}\"";
<% end %>

case "${1}" in
  start)
    mkdir -p \
      "${REDIS_SENTINEL_RUN_DIR}" \
      "${REDIS_SENTINEL_LOG_DIR}" \
      "${REDIS_SENTINEL_STORE_DIR}";

    chown vcap:vcap \
      "${REDIS_SENTINEL_RUN_DIR}" \
      "${REDIS_SENTINEL_LOG_DIR}" \
      "${REDIS_SENTINEL_STORE_DIR}";

    chmod 750 "${REDIS_SENTINEL_STORE_DIR}";
    touch "${REDIS_SENTINEL_LOG_FILE}";
    chown vcap:vcap "${REDIS_SENTINEL_LOG_FILE}";
    chmod 660 "${REDIS_SENTINEL_CONF}";

<% if sentinel.p('tls') %>
    mkdir -p "${REDIS_SENTINEL_TLS_KEYS_DIR}";
    printf "%s\n" "<%= p('tls_keys').certificate %>" > \
      "${REDIS_SENTINEL_TLS_CERT_FILE}";
    printf "%s\n" "<%= p('tls_keys').private_key %>" > \
      "${REDIS_SENTINEL_TLS_KEY_FILE}";
    printf "%s\n" "<%= p('tls_keys').ca %>" > \
      "${REDIS_SENTINEL_TLS_CA_CERT_FILE}";
    chown -R vcap:vcap "${REDIS_SENTINEL_TLS_KEYS_DIR}";
    chmod -R g-rwx,o-rwx "${REDIS_SENTINEL_TLS_KEYS_DIR}";
<% end %>

    # Remove temp backup files that might be left over because of a
    # previously aborted
    rm -f "${REDIS_SENTINEL_STORE_DIR}"/*

    ulimit -n 10032

    if [[ -f "${REDIS_SENTINEL_PID_FILE}" ]];
    then
      echo "${REDIS_SENTINEL_PID_FILE} exists, process is already running or crashed";
    else
      echo "Starting Redis Sentinel...";
      exec chpst -u vcap:vcap "${REDIS_SERVER}" \
        "${REDIS_SENTINEL_CONF}" \
        --sentinel \
        >> "${REDIS_SENTINEL_LOG_FILE}" 2>&1;
    fi
    ;;
  stop)
    if [[ -f "${REDIS_SENTINEL_PID_FILE}" ]];
    then
      redis_sentinel_pid="$(cat ${REDIS_SENTINEL_PID_FILE})";
      echo "Stopping ...";
      exec chpst -u vcap:vcap \
        "${REDIS_CLI}" \
          -h "${REDIS_SENTINEL_IP}" \
          -p "${REDIS_SENTINEL_PORT}" \
          ${REDIS_SENTINEL_CRED} \
          SHUTDOWN;
      while [[ -x "/proc/${redis_sentinel_pid}" ]];
      do
        echo "Waiting for Redis Sentinel to shutdown ...";
        sleep 1;
      done
      rm -f "${REDIS_SENTINEL_PID_FILE}"
      echo "Redis Sentinel stopped";
    else
      echo "${REDIS_SENTINEL_PID_FILE} does not exist, process is not running";
    fi
    ;;
  *)
    echo "Usage: ${0} {start|stop}";
  ;;
esac
