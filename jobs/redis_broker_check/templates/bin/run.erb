#!/bin/bash
<% broker=link('redis_broker_conn') %>

BROKER_IP="127.0.0.1";
<%- if broker.p('bind') -%>
BROKER_IP="<%= spec.ip %>";
<%- end
  if broker.p('tls') -%>
PROTOCOLE="https";
BROKER_PORT="<%= broker.p('tls_port') %>";
<%- else -%>
PROTOCOLE="http";
BROKER_PORT="<%= broker.p('port') %>";
<%- end -%>

BASE_URI="${PROTOCOLE}://<%= broker.p('user') %>:<%= broker.p('password') %>@${BROKER_IP}:${BROKER_PORT}";

ERR_CATALOG=1;
if [[ "$(curl -s -o /dev/null -I -w "%{http_code}" \
  ${BASE_URI}/v2/catalog)" == "200" ]];
then
  ERR_CATALOG=0;
  echo "$(curl -s ${BASE_URI}/v2/catalog)";
  echo "Catalog: OK";
else
  echo "Catalog: KO";
fi

ERR_BINDING=1;
if [[ "$(curl -s -o /dev/null -I -w "%{http_code}" \
  ${BASE_URI}/v2/service_instances/:instance_id/service_bindings/:binding_id)" == "200" ]];
then
  ERR_BINDING=0;
  echo "$(curl -s \
  ${BASE_URI}/v2/service_instances/:instance_id/service_bindings/:binding_id)";
  echo "Binding: OK";
else
  echo "Binding: KO";
fi

ERR=1;
if [[ ${ERR_CATALOG} -eq 0 ]] && [[ ${ERR_BINDING} -eq 0 ]];
then
  ERR=0;
fi

exit ${ERR};