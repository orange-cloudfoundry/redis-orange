#!/bin/bash
<%- master=link('redis_conn')
  slave=nil
  if_link('slave_conn'){ |x| slave=x }
  sentinel=nil
  if_link('redis_sentinel_conn'){ |x| sentinel=x }
  sentinel_slave=nil
  if_link('sentinel_slave_conn'){ |x| sentinel_slave=x } -%>

ERR=0;
REDIS_HOME="/var/vcap/packages/redis";
REDIS_CLI="${REDIS_HOME}/bin/redis-cli";

REDIS_IP="127.0.0.1";
<%- if master.p('bind') -%>
REDIS_IP="<%= spec.ip %>";
<%- end -%>
REDIS_PORT="<%= master.p('port') %>";
REDIS_CRED="--user <%= master.p('admin_user') %>";
<%- master.if_p('admin_password') do |x|
    unless x.to_s.empty? -%>
REDIS_CRED+=" --pass <%= x %>";
<%- end
  end
  if master.p('tls') -%>
REDIS_PORT="<%= master.p('tls_port') %>";
REDIS_TLS_KEYS_DIR="<%= p('tls_keys_dir') %>";
REDIS_TLS_CERT_FILE="${REDIS_TLS_KEYS_DIR}/<%= p('tls_cert_file') %>";
REDIS_CRED+=" --tls --cert ${REDIS_TLS_CERT_FILE}";
REDIS_TLS_KEY_FILE="${REDIS_TLS_KEYS_DIR}/<%= p('tls_key_file') %>";
REDIS_CRED+=" --key ${REDIS_TLS_KEY_FILE}";
REDIS_TLS_CA_CERT_FILE="${REDIS_TLS_KEYS_DIR}/<%= p('tls_ca_cert_file') %>";
REDIS_CRED+=" --cacert ${REDIS_TLS_CA_CERT_FILE}";
<%- end -%>

#
# Bind to Sentinel
#
<%- if !sentinel.nil? && master.p('replication') && master.instances.find{ |x| x.bootstrap }.address.eql?(spec.address) -%>
REDIS_SENTINEL_PORT="<%= sentinel.p('port') %>";
REDIS_SENTINEL_CRED="";
<%- sentinel.if_p('password') do |x|
    unless x.to_s.empty? -%>
REDIS_SENTINEL_CRED="-a <%= x %>";
<%- end
  end 
  if sentinel.p('tls') -%>
REDIS_SENTINEL_PORT="<%= sentinel.p('tls_port') %>";
REDIS_SENTINEL_CRED+=" --tls --cert ${REDIS_TLS_CERT_FILE}";
REDIS_SENTINEL_CRED+=" --key ${REDIS_TLS_KEY_FILE}";
REDIS_SENTINEL_CRED+=" --cacert ${REDIS_TLS_CA_CERT_FILE}";
<%- end
  master_port=master.p('port')
  if master.p('tls') && master.p('tls_replication')
    master_port=master.p('tls_port')
  end -%>
REDIS_SENTINEL_CMD="SENTINEL MONITOR <%= spec.deployment %> <%= master.instances.find{ |x| x.bootstrap }.address %> <%= master_port %> <%= master.p('max_detected_failures') %>\n";
<%- master.if_p('sentinel_password') do |x|
    unless x.to_s.empty? -%>
REDIS_SENTINEL_CMD+="SENTINEL SET <%= spec.deployment %> AUTH-PASS <%= x %>\n";
<%- end
  end -%>
REDIS_SENTINEL_CMD+="SENTINEL SET <%= spec.deployment %> AUTH-USER <%= master.p('sentinel_user') %>\n";
REDIS_SENTINEL_CMD+="SENTINEL SET <%= spec.deployment %> DOWN-AFTER-MILLISECONDS <%= master.p('down_after_milliseconds') %>\n";
REDIS_SENTINEL_CMD+="SENTINEL SET <%= spec.deployment %> PARALLEL-SYNCS <%= master.p('parallel_syncs') %>\n";
REDIS_SENTINEL_CMD+="SENTINEL SET <%= spec.deployment %> FAILOVER-TIMEOUT <%= master.p('failover_timeout') %>\n";

REDIS_SENTINEL_ADDRESS="";
<%- sentinel_addresses=''
  sentinel.instances.each{ |x| sentinel_addresses.concat(x.address).concat(' ') }
  if !sentinel_slave.nil?
    sentinel_slave.instances.each{ |x| sentinel_addresses.concat(x.address).concat(' ') }
  end -%>
REDIS_SENTINEL_ADDRESSES="<%= sentinel_addresses %>";
REDIS_SENTINEL_DONE="";
for x in ${REDIS_SENTINEL_ADDRESSES};
do
  MSG="$(echo -e "${REDIS_SENTINEL_CMD}" | \
    "${REDIS_CLI}" \
      -h "${x}" \
      -p "${REDIS_SENTINEL_PORT}" \
      ${REDIS_SENTINEL_CRED})";
  if [[ ! ${?} -eq 0 ]];
  then
    ERR=1;
    echo "ERROR: Commands failed with Sentinel \"${x}\": \"${MSG}\".";
    break;
  fi
  REDIS_SENTINEL_DONE+="${x} ";
done

if [[Â ${ERR} -eq 1 ]];
then
  for x in ${REDIS_SENTINEL_DONE};
  do
    "${REDIS_CLI}" \
      -h "${x}" \
      -p "${REDIS_SENTINEL_PORT}" \
      ${REDIS_SENTINEL_CRED} \
      SENTINEL REMOVE <%= spec.deployment %>;
  done
fi
<%- end -%>

#
# Build Redis cluster
#
<%- if master.p('cluster_enabled').eql?('yes') && master.instances.find{ |x| x.bootstrap }.address.eql?(spec.address)
  node_port=master.p('port')
  if master.p('tls') && master.p('tls_cluster')
    node_port=master.p('tls_port')
  end
  master_addresses=''
  master.instances.each{ |x| master_addresses.concat(x.address).concat(' ') }
  master_instances=master.instances.length
  replicas_per_node=master.p('cluster_replicas_per_node').to_i
  slaves_addresses=''
  slave_instances=0
  if !slave.nil?
    slave.instances.each{ |x| slaves_addresses.concat(x.address).concat(' ') }
    slave_instances=slave.instances.length
  elsif replicas_per_node>0
    if master_instances>replicas_per_node
      addresses=master_addresses.split
      master_instances=master_instances.div(replicas_per_node+1)
      master_addresses=addresses.slice(0, master_instances-1).join(' ')
      slaves_addresses=addresses.slice(master_instances, -1)
      slave_instances=slaves_addresses.length
      slaves_addresses=slaves_addresses.join(' ')
    else
      replicas_per_node=0
    end
  end
  if replicas_per_node>0 && master_instances*replicas_per_node>slave_instances
    STDERR.puts "WARNING: Not enough slave: masters [#{master_instances}], slaves [#{slave_instances}], slaves per master [#{replicas_per_node}]"
  end -%>
REDIS_MASTER_ADDRESSES="<%= master_addresses %>";
REDIS_SLAVE_ADDRESSES="<%= slaves_addresses %>";
REDIS_ADDRESSES="${REDIS_MASTER_ADDRESSES} ${REDIS_SLAVE_ADDRESSES}";
REDIS_INSTANCES="<%= master_instances+slave_instances %>";
REPLICAS_PER_NODE="<%= replicas_per_node %>";

echo "Masters addresses: [${REDIS_MASTER_ADDRESSES}]";
echo "Number of masters: [<%= master_instances %>]";
echo "Slaves addresses: [${REDIS_SLAVE_ADDRESSES}]";
echo "Number of slaves: [<%= slave_instances %>]";
echo "Wished replicas per master: [${REPLICAS_PER_NODE}]";

MSG="$("${REDIS_CLI}" \
  -h "${REDIS_IP}" \
  -p "${REDIS_PORT}" \
  ${REDIS_CRED} \
  CLUSTER NODES)";
ERR=${?};
if [[ ${ERR} -eq 0 ]];
then
  echo "Redis CLUSTER NODES command results:";
  echo "${MSG}";
  AVAILABLE_NODES=0;
  for i in $(echo "${MSG}" | awk '{print $2;}');
  do
    for j in ${REDIS_ADDRESSES};
    do
      if [[ "${i%%@*}" == "${j}:<%= node_port %>" ]];
      then
        ((AVAILABLE_NODES++));
      fi
    done
  done
  if [[ ${REDIS_INSTANCES} -eq ${AVAILABLE_NODES} ]];
  then
    echo "ERROR: All requested nodes are already in a cluster." >&2;
    exit 0;
  fi
fi

AVAILABLE_NODES=0;
while [[ ${REDIS_INSTANCES} -gt ${AVAILABLE_NODES} ]];
do
  AVAILABLE_NODES=0;
  for i in ${REDIS_ADDRESSES};
  do
    PING="$("${REDIS_CLI}" \
      -h "${i}" \
      -p "${REDIS_PORT}" \
      ${REDIS_CRED} \
      PING)";
    if [[ ${?} -eq 0 ]] && [[ "${PING}" == "PONG" ]];
    then
      ((AVAILABLE_NODES++));
    fi
  done
done

if [[ ${REDIS_INSTANCES} -eq ${AVAILABLE_NODES} ]];
then
  REDIS_NODES="";
  for i in ${REDIS_ADDRESSES};
  do
    REDIS_NODES+=" ${i}:<%= node_port %>";
  done
  "${REDIS_CLI}" \
    ${REDIS_CRED} \
    --cluster create ${REDIS_NODES} <<< "yes";
  ERR=${?};
  if [[ ${ERR} -eq 0 ]] && [[ ${REPLICAS_PER_NODE} -gt 0 ]];
  then
    for i in ${REDIS_MASTER_ADDRESSES};
    do
      MASTER_ID="$("${REDIS_CLI}" \
        -h "${i}" \
        -p "${REDIS_PORT}" \
        ${REDIS_CRED} \
        CLUSTER MYID)";
      ERR=${?};
      j=0;
      while [[ ${ERR} -eq 0 ]] && \
        [[ -n "${REDIS_SLAVE_ADDRESSES}" ]] && \
        [[ ${j} -lt ${REPLICAS_PER_NODE} ]];
      do
        "${REDIS_CLI}" \
          ${REDIS_CRED} \
          --cluster add-node ${REDIS_SLAVE_ADDRESSES%% *}:<%= node_port %> \
          ${i}:<%= node_port %> \
          --cluster-slave \
          --cluster-master-id ${MASTER_ID} <<< "yes";
        ERR=${?};
        REDIS_SLAVE_ADDRESSES="${REDIS_SLAVE_ADDRESSES#* }";
        ((j++));
      done
    done

    while [[ ${ERR} -eq 0 ]] && \
      [[ -n "${REDIS_SLAVE_ADDRESSES}" ]];
    do
      for i in ${REDIS_MASTER_ADDRESSES};
      do
        MASTER_ID="$("${REDIS_CLI}" \
          -h "${i}" \
          -p "${REDIS_PORT}" \
          ${REDIS_CRED} \
          CLUSTER MYID)";
        ERR=${?};
        "${REDIS_CLI}" \
          ${REDIS_CRED} \
          --cluster add-node ${REDIS_SLAVE_ADDRESSES%% *}:<%= node_port %> \
          ${i}:<%= node_port %> \
          --cluster-slave \
          --cluster-master-id ${MASTER_ID} <<< "yes";
        ERR=${?};
        REDIS_SLAVE_ADDRESSES="${REDIS_SLAVE_ADDRESSES#* }";
        if [[ -z "${REDIS_SLAVE_ADDRESSES}" ]];
        then
          break;
        fi
      done
    done
  fi
  MSG="$("${REDIS_CLI}" \
    -h "${REDIS_IP}" \
    -p "${REDIS_PORT}" \
    ${REDIS_CRED} \
    CLUSTER NODES)";
  ERR=${?};
  if [[ ${ERR} -eq 0 ]];
  then
    echo "Redis CLUSTER NODES command results:";
    echo "${MSG}";
  fi
fi
<%- end -%>

exit ${ERR};
