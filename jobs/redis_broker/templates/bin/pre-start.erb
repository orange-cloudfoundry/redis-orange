#!/bin/bash
ERR=0;
<%- p('tls') -%>
export JAVA_HOME=/var/vcap/packages/openjdk/jdk;
export PATH=${JAVA_HOME}/bin:${PATH};
source /var/vcap/packages/redis_broker/bin/gen-certs.sh;
TLS_KEYS_DIR="<%= p('tls_keys_dir') %>";
TLS_P12_FILE="${TLS_KEYS_DIR}/<%= p('tls_p12_file') %>";
TLS_JKS_FILE="${TLS_KEYS_DIR}/<%= p('tls_jks_file') %>";
TLS_KEY_ALIAS="<%= p('tls_key_alias') %>";
<%- if !link('redis_conn').p('tls') -%>
gen_ca \
  "${TLS_KEYS_DIR}/<%= p('tls_ca_key_file') %>" \
  "${TLS_KEYS_DIR}/<%= p('tls_ca_cert_file') %>" \
  "<%= p('tls_ca_key_length') %>" \
  "<%= p('tls_ca_cert_duration') %>" \
  "<%= spec.deployment %>" && \
<%- end -%>
gen_signed_cert \
  "${TLS_KEYS_DIR}/<%= p('tls_ca_key_file') %>" \
  "${TLS_KEYS_DIR}/<%= p('tls_ca_cert_file') %>" \
  "${TLS_KEYS_DIR}/ca.txt" \
  "${TLS_KEYS_DIR}/<%= p('tls_key_file') %>" \
  "${TLS_KEYS_DIR}/<%= p('tls_cert_file') %>" \
  "<%= p('tls_key_length') %>" \
  "<%= p('tls_cert_duration') %>" \
  "<%= spec.deployment %>" \
  "Redis Broker Server" && \
rm -f \
  "${TLS_P12_FILE}" \
  "${TLS_JKS_FILE}" && \
openssl pkcs12 -export \
  -name "${TLS_KEY_ALIAS}" \
  -inkey "${TLS_KEY_FILE}" \
  -in "${TLS_CERT_FILE}" \
  -out "${TLS_P12_FILE}" && \
keytool -importkeystore \
  -srcstoretype PKCS12 \
  -srckeystore "${TLS_P12_FILE}" \
  -deststoretype JKS \
  -destkeystore "${TLS_JKS_FILE}";
ERR=${?};
<%- end -%>
exit ${ERR};
